---
title: "Krystalografia"
author: "Joanna So쓾miewicz"
date: "15 listopada 2018"
output: 
  html_document: 
    theme: spacelab
    toc: yes
    toc_float: yes
---

#Wykorzystane biblioteki
```{r loading libraries, message = FALSE}
library(dplyr)
library(ggplot2)
library(plotly)
library(tidyr)
library(knitr)
library(caret)
library(data.table)
library(tibble)
```

#Wczytywanie danych
```{r reading data}
removable_columns <- c("title", "pdb_code", "res_id", "chain_id", "local_res_atom_count", "local_res_atom_non_h_occupancy_sum", "local_res_atom_non_h_electron_occupancy_sum", "local_res_atom_C_count", "local_res_atom_N_count", "local_res_atom_O_count", "local_res_atom_S_count", "dict_atom_C_count", "dict_atom_N_count", "dict_atom_O_count", "dict_atom_S_count", "skeleton_data", "skeleton_cycle_4", "skeleton_diameter", "skeleton_cycle_6", "skeleton_cycle_7", "skeleton_closeness_006_008", "skeleton_closeness_002_004", "skeleton_cycle_3", "skeleton_avg_degree", "skeleton_closeness_004_006", "skeleton_closeness_010_012", "skeleton_closeness_012_014", "skeleton_edges", "skeleton_radius", "skeleton_cycle_8_plus", "skeleton_closeness_020_030", "skeleton_deg_5_plus", "skeleton_closeness_016_018", "skeleton_closeness_008_010", "skeleton_closeness_018_020", "skeleton_average_clustering", "skeleton_closeness_040_050", "skeleton_closeness_014_016", "skeleton_center", "skeleton_closeness_000_002", "skeleton_density", "skeleton_closeness_030_040", "skeleton_deg_4", "skeleton_deg_0", "skeleton_deg_1", "skeleton_deg_2", "skeleton_deg_3", "skeleton_graph_clique_number", "skeleton_nodes", "skeleton_cycles", "skeleton_cycle_5", "skeleton_closeness_050_plus", "skeleton_periphery", "fo_col", "fc_col", "weight_col", "grid_space", "solvent_radius", "solvent_opening_radius", "part_step_FoFc_std_min", "part_step_FoFc_std_max", "part_step_FoFc_std_step")

data <- fread("./all_summary.csv", nrows = 10000, header = TRUE, drop = removable_columns)
dim(data)
```

#Przetwarzanie brakuj젺ych danych
```{r processing missing data}
dim(data)
data <- data %>% 
  drop_na()
dim(data)
```

#Usuwanie niepotrzebnych ligand雕
```{r deleting chosen ligands}
deletable_res_name <- c("UNK", "UNX", "UNL", "DUM", "N", "BLOB", "ALA", "ARG", "ASN", "ASP", "CYS", "GLN", "GLU", "GLY", "HIS", "ILE", "LEU", "LYS", "MET", "MSE", "PHE", "PRO", "SEC", "SER", "THR", "TRP", "TYR", "VAL", "DA", "DG", "DT", "DC", "DU", "A", "G", "T", "C", "U", "HOH", "H20", "WAT")
data <- data %>% filter(!res_name %in% deletable_res_name)
dim(data)
```

#Podsumowanie danych
```{r data summary}
cols_summary <- c("res_name", "local_res_atom_non_h_count", "local_res_atom_non_h_electron_sum", "dict_atom_non_h_count", "dict_atom_non_h_electron_sum")
statistics <- data %>%
  select(one_of(cols_summary))
kable(summary(statistics))
dim(data)
```

#50 najpopularniejszych ligand雕
```{r 50 most popular ligands}
popular_ligands <- data %>%
  select(res_name) %>%
  count(res_name, sort = TRUE) %>%
  slice(1:50)

popular_names_vector <- popular_ligands %>%
  pull(res_name)

data <- data %>% filter(res_name %in% popular_names_vector)
dim(data)
```

#Liczno럱 najpopularniejszych ligand雕 wed씃g nazwy
```{r cardinality of ligands}
plot_ligands <- ggplot(popular_ligands, aes(x = reorder(res_name, -n), y = n, fill = n)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("ligand")+
  ylab("liczno럱") +
  labs(title = "Liczno럱 ligand雕 wed씃g nazwy")

ggplotly(plot_ligands)
```

#Korelacja mi師zy zmiennymi
```{r correlation between variables, warning=FALSE}
data %>%
  select_if(is.numeric) %>%
  cor() %>%
  as.data.frame() %>%
  rownames_to_column() %>%
  gather(rowname2, value, -rowname) %>%
  filter(value >= 0.9999, rowname != rowname2)
```

#Rozk쓰dy g砂to띾iowe liczb
##Atom雕
```{r distribution of atom count}
plot_atom <- ggplot(data, aes(x = local_res_atom_non_h_count)) +
  geom_density(alpha = .3, fill = "#00CECB", color = NA) +
  xlab("liczno럱 atom雕") +
  ylab("g砂to럱") +
  labs(title = "Rozk쓰d g砂to띾iowy atom雕")

ggplotly(plot_atom)
```

##Elektron雕
```{r distribution of electron count}
plot_electron <- ggplot(data, aes(x = local_res_atom_non_h_electron_sum)) +
  geom_density(alpha = .3, fill = "#FF5E5B", color = NA) +
  xlab("liczno럱 elektron雕") +
  ylab("g砂to럱") +
  labs(title = "Rozk쓰d g砂to띾iowy elektron雕")

ggplotly(plot_electron)
```

#Rozk쓰d warto띾i kolumn part_01
```{r distribution of part_01 columns}
remove_outliers <- function(data, na.rm = TRUE, ...) {
  qnt <- quantile(data, probs=c(.25, .75), na.rm = na.rm, ...)
  iqr <- 1.5 * IQR(data, na.rm = na.rm)
  data_no_outliers <- data
  data_no_outliers[data < (qnt[1] - iqr)] <- NA
  data_no_outliers[data > (qnt[2] + iqr)] <- NA
  data_no_outliers[!is.na(data_no_outliers)]
  data_no_outliers
}

plot_part_data <- data %>%
  select(contains("part_01"))
dim(plot_part_data)

plot_part_data <- plot_part_data %>%
  sapply(remove_outliers) %>%
  as.data.frame()
dim(plot_part_data)

plot_part_data <- plot_part_data %>%
  drop_na()
dim(plot_part_data)

names(plot_part_data) <- gsub("part_01_", "", names(plot_part_data))

plots <- lapply(seq_along(plot_part_data), function(var) {
    plot_ly(x =  names(plot_part_data[var]), y = ~plot_part_data[,var], type = "box", height = 3000) %>%
    layout(xaxis = list(tickangle = 10))
})

subplot(plots, nrows = 16, shareY = FALSE, shareX = FALSE, margin = 0.01, heights = rep(1/16, 16)) %>%
  layout(showlegend = FALSE)
```

#Najwi査sze niezgodno띾i liczby
##Atom雕
```{r greatest inconsistency in atom}
data %>%
  select(res_name, local_res_atom_non_h_count, dict_atom_non_h_count) %>%
  group_by(res_name) %>%
  summarise(atom_inconsistency = mean(abs(local_res_atom_non_h_count - dict_atom_non_h_count))) %>%
  arrange(-atom_inconsistency) %>%
  slice(1:10) %>%
  kable()
```

##Elektron雕
```{r greatest inconsistency in electron}
data %>%
  select(res_name, local_res_atom_non_h_electron_sum, dict_atom_non_h_electron_sum) %>%
  group_by(res_name) %>%
  summarise(electron_inconsistency = mean(abs(local_res_atom_non_h_electron_sum - dict_atom_non_h_electron_sum))) %>%
  arrange(-electron_inconsistency) %>%
  slice(1:10) %>%
  kable()
```

#Regresja liniowa
##Liczba atom雕
```{r linear regression atom, error=FALSE, warning=FALSE, message=FALSE}
data_partition <- data %>%
  select_if(is.numeric)

set.seed(111)
partition <- createDataPartition(
  y = data_partition$local_res_atom_non_h_count,
  p = .7,
  list = FALSE)

data_train <- data_partition %>%
  slice(partition)
data_test <- data_partition %>%
  slice(-partition)
dim(data_train)
dim(data_test)

set.seed(111)
fit <- train(local_res_atom_non_h_count ~ ., data = data_train, method = "lm")
fit

set.seed(111)
prediction <- predict(fit, newdata = data_test)
postResample(pred = prediction, obs = data_test$local_res_atom_non_h_count)
```

##Liczba elektron雕
```{r linear regression electron, error=FALSE, warning=FALSE, message=FALSE}
data_partition <- data %>%
  select_if(is.numeric)

set.seed(111)
partition <- createDataPartition(
  y = data_partition$local_res_atom_non_h_electron_sum,
  p = .7,
  list = FALSE)

data_train <- data_partition %>%
  slice(partition)
data_test <- data_partition %>%
  slice(-partition)
dim(data_train)
dim(data_test)

set.seed(111)
fit <- train(local_res_atom_non_h_electron_sum ~ ., data = data_train, method = "lm")
fit

set.seed(111)
prediction <- predict(fit, newdata = data_test)
postResample(pred = prediction, obs = data_test$local_res_atom_non_h_electron_sum)
```

#Klasyfikator
####Przewidywanie warto띾i res_name
```{r classification}
dim(data)

removable_columns <- c("blob_coverage", "res_coverage", "local_res_atom_non_h_count", "local_res_atom_non_h_electron_sum", "dict_atom_non_h_count", "dict_atom_non_h_electron_sum")
data_partition <- data %>%
  select(-removable_columns)

dim(data_partition)

data_partition$res_name <- as.factor(data_partition$res_name)

set.seed(111)
partition <- createDataPartition(
  y = data_partition$res_name,
  p = .7,
  list = FALSE)

data_train <- data_partition %>%
  slice(partition)
data_test <- data_partition %>%
  slice(-partition)
dim(data_train)
dim(data_test)

set.seed(111)
fit <- train(
  res_name ~ .,
  data = data_train,
  method = "rf",
  ntree = 10,
  na.action  = na.pass)
fit

set.seed(111)
prediction <- predict(fit, newdata = data_test)
confusionMatrix(data = prediction, data_test$res_name)
```

